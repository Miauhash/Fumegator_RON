"use strict";(()=>{var e={};e.id=7504,e.ids=[7504],e.modules={3524:e=>{e.exports=require("@prisma/client")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6050:(e,t,a)=>{a.r(t),a.d(t,{config:()=>u,default:()=>o,routeModule:()=>c});var r={};a.r(r),a.d(r,{default:()=>handler});var s=a(1802),n=a(7153),i=a(6249),l=a(7864);let d={1:{tiers:[{threshold:5e3,rewards:{vida:200,freeSpins:5}},{threshold:2e3,rewards:{vida:50,items:["accelerator_1h"]}},{threshold:500,rewards:{vida:10,freeSpins:1}}]}};async function handler(e,t){try{let e=await l.Z.globalEvent.findMany({where:{isActive:!0,endsAt:{lt:new Date}},include:{contributions:!0}});if(0===e.length)return t.status(200).json({success:!0,message:"No events to end."});for(let t of e){let e=t.contributions.reduce((e,t)=>(e[t.userWallet]=(e[t.userWallet]||0)+t.amount,e),{});for(let a in e){let r=d[t.id]?.tiers.find(t=>e[a]>=t.threshold);if(r){let e=await l.Z.gameState.findUnique({where:{wallet:a}});if(!e)continue;let t=e.state;t.balances=t.balances||{},t.balances.VIDA=(t.balances.VIDA||0)+(r.rewards.vida||0),t.freeSpins=(t.freeSpins||0)+(r.rewards.freeSpins||0),await l.Z.gameState.update({where:{wallet:a},data:{state:t}})}}await l.Z.globalEvent.update({where:{id:t.id},data:{isActive:!1}})}t.status(200).json({success:!0,message:"Events ended and rewards distributed."})}catch(e){console.error("Error ending event:",e),t.status(500).json({success:!1,error:"Internal server error"})}}let o=(0,i.l)(r,"default"),u=(0,i.l)(r,"config"),c=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/events/end-event",pathname:"/api/events/end-event",bundlePath:"",filename:""},userland:r})},7864:(e,t,a)=>{let r;a.d(t,{Z:()=>n});var s=a(3524);console.log("INICIALIZANDO PRISMA CLIENT. CONECTANDO AO BANCO DE DADOS:",process.env.DATABASE_URL),global.prisma||(global.prisma=new s.PrismaClient),r=global.prisma;let n=r}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222],()=>__webpack_exec__(6050));module.exports=a})();