"use strict";(()=>{var e={};e.id=1788,e.ids=[1788],e.modules={3524:e=>{e.exports=require("@prisma/client")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7606:(e,a,r)=>{r.r(a),r.d(a,{config:()=>m,default:()=>d,routeModule:()=>p});var t={};r.r(t),r.d(t,{default:()=>handler});var o=r(1802),s=r(7153),n=r(6249),i=r(7864),l=r(578);!function(){var e=Error("Cannot find module 'ethers'");throw e.code="MODULE_NOT_FOUND",e}();let c=["Rare","Epic","Legendary"];async function hasMarketAccess(e){try{let a=Object(function(){var e=Error("Cannot find module 'ethers'");throw e.code="MODULE_NOT_FOUND",e}()).providers.JsonRpcProvider("https://saigon-testnet.roninchain.com/rpc"),r=await (0,l.F)(e,a),t=c.map(e=>e.toLowerCase());return r.some(e=>e.rarity&&t.includes(e.rarity.toLowerCase()))}catch(e){return console.error("Falha ao verificar NFTs para acesso ao mercado:",e),!1}}async function handler(e,a){if("POST"!==e.method)return a.status(405).json({message:"M\xe9todo n\xe3o permitido."});let{buyerWallet:r,listingId:t}=e.body;if(!r||!t)return a.status(400).json({message:"Dados inv\xe1lidos para realizar a compra."});let o=await hasMarketAccess(r);if(!o)return a.status(403).json({message:"Voc\xea n\xe3o tem permiss\xe3o para comprar no mercado."});try{let e=await i.Z.$transaction(async e=>{let a=await e.marketListing.findUnique({where:{id:t}});if(!a)throw Error("An\xfancio n\xe3o encontrado.");if(!a.isActive)throw Error("Este an\xfancio n\xe3o est\xe1 mais ativo.");if(a.sellerWallet===r)throw Error("Voc\xea n\xe3o pode comprar seu pr\xf3prio an\xfancio.");let o=await e.gameState.findUnique({where:{wallet:r}});if(!o)throw Error("Jogador (comprador) n\xe3o encontrado.");let s=a.amount*a.pricePerUnitInVIDA,n=o.state,i=n.balances?.VIDA||0;if(i<s)throw Error(`Saldo de VIDA insuficiente. Voc\xea precisa de ${s.toFixed(2)} VIDA.`);let l=await e.gameState.findUnique({where:{wallet:a.sellerWallet}});if(!l)throw Error("Vendedor n\xe3o encontrado. A transa\xe7\xe3o foi cancelada para sua seguran\xe7a.");let c=l.state;return n.balances.VIDA-=s,n.balances[a.tokenType]=(n.balances[a.tokenType]||0)+a.amount,c.balances.VIDA=(c.balances.VIDA||0)+s,await e.gameState.update({where:{wallet:r},data:{state:n}}),await e.gameState.update({where:{wallet:a.sellerWallet},data:{state:c}}),await e.marketListing.update({where:{id:t},data:{isActive:!1}})});a.status(200).json({message:"Compra realizada com sucesso!",listing:e})}catch(e){console.error("Erro ao comprar item no mercado:",e),a.status(400).json({message:e.message||"N\xe3o foi poss\xedvel realizar a compra."})}}let d=(0,n.l)(t,"default"),m=(0,n.l)(t,"config"),p=new o.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/market/buy",pathname:"/api/market/buy",bundlePath:"",filename:""},userland:t})},7864:(e,a,r)=>{let t;r.d(a,{Z:()=>s});var o=r(3524);console.log("INICIALIZANDO PRISMA CLIENT. CONECTANDO AO BANCO DE DADOS:",process.env.DATABASE_URL),global.prisma||(global.prisma=new o.PrismaClient),t=global.prisma;let s=t}};var a=require("../../../webpack-api-runtime.js");a.C(e);var __webpack_exec__=e=>a(a.s=e),r=a.X(0,[4222,578],()=>__webpack_exec__(7606));module.exports=r})();